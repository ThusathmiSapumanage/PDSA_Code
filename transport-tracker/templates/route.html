{% extends "_layout.html" %}
{% block content %}
<div class="d-flex flex-wrap gap-3 justify-content-between align-items-center">
  <div>
    <h4 class="mb-0"><i class="bi bi-signpost-2"></i> Route {{ route_id }}</h4>
    <small class="text-secondary">Stop: <strong>{{ stop_name }}</strong></small>
  </div>
  <div class="d-flex align-items-center gap-3">
    <small class="text-secondary">Last update: <span id="last-updated">now</span></small>
    <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('incidents', route_id=route_id) }}">
      <i class="bi bi-exclamation-triangle"></i> Incidents
    </a>
  </div>
</div>

<div class="card shadow-sm mt-3">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0" id="arrivals-table">
        <thead class="table-light">
          <tr><th style="width: 140px;">ETA</th><th>Vehicle</th><th style="width: 320px;">Action</th></tr>
        </thead>
        <tbody id="arrivals-body">
          {% for eta, vid in arrivals %}
          <tr>
            <td class="fw-medium">{{ eta }}</td>
            <td><span class="badge text-bg-primary">{{ vid }}</span></td>
            <td class="d-flex flex-wrap gap-2">
              <button type="button" class="btn btn-sm btn-outline-primary" onclick="openReport('delay','{{ vid }}')"><i class="bi bi-hourglass-split"></i> Delay</button>
              <button type="button" class="btn btn-sm btn-outline-danger"  onclick="openReport('breakdown','{{ vid }}')"><i class="bi bi-tools"></i> Breakdown</button>
              <button type="button" class="btn btn-sm btn-outline-success" onclick="depart('{{ vid }}')"><i class="bi bi-check2-circle"></i> Departed</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- skeleton -->
    <div id="skeleton" class="p-3 d-none">
      <div class="placeholder-glow">
        <span class="placeholder col-2"></span>
        <span class="placeholder col-3 ms-2"></span>
        <span class="placeholder col-4 ms-2"></span>
      </div>
      <div class="placeholder-glow mt-2">
        <span class="placeholder col-1"></span>
        <span class="placeholder col-3 ms-2"></span>
        <span class="placeholder col-4 ms-2"></span>
      </div>
    </div>
  </div>

  <div class="p-3">
    <h6 class="text-secondary mb-2">Recent reports</h6>
    <div id="recent-reports" class="small text-secondary">Loadingâ€¦</div>
  </div>
</div>

<!-- Report Modal -->
<div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reportLabel">Submit report</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3">
          <div class="col-12">
            <label class="form-label">Vehicle</label>
            <input id="report-vehicle" class="form-control" readonly>
          </div>
          <div class="col-sm-6">
            <label class="form-label">Type</label>
            <select id="report-type" class="form-select">
              <option value="delay">Delay</option>
              <option value="breakdown">Breakdown</option>
              <option value="crowding">Crowding</option>
            </select>
          </div>
          <div class="col-sm-6">
            <label class="form-label">Severity: <span id="sev-val">3</span></label>
            <input type="range" id="report-sev" class="form-range" min="1" max="10" value="3" oninput="document.getElementById('sev-val').textContent=this.value">
          </div>
          <div class="col-12">
            <label class="form-label">Message</label>
            <input id="report-msg" class="form-control" placeholder="Optional note">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" onclick="submitReport()">Submit</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const routeId = "{{ route_id }}";
  const stopName = "{{ stop_name }}";

  // Modal
  let reportModal;
  const modalEl = document.getElementById('reportModal');
  if (window.bootstrap && modalEl) reportModal = new bootstrap.Modal(modalEl);
  function ensureModal(){
    if (!reportModal && window.bootstrap && modalEl) reportModal = new bootstrap.Modal(modalEl);
  }

  // Actions
  window.openReport = function(type, vid){
    ensureModal();
    document.getElementById('report-vehicle').value = vid;
    document.getElementById('report-type').value = type;
    const defaultSev = (type === 'delay') ? 3 : 8;
    document.getElementById('report-sev').value = defaultSev;
    document.getElementById('sev-val').textContent = defaultSev;
    document.getElementById('report-msg').value = '';
    reportModal?.show();
  };

  window.submitReport = async function(){
    const vid = document.getElementById('report-vehicle').value;
    const type = document.getElementById('report-type').value;
    const severity = document.getElementById('report-sev').value;
    const message = document.getElementById('report-msg').value;
    try{
      const resp = await axios.post('/api/report', {
        route_id: routeId, vehicle_id: vid, stop_name: stopName,
        report_type: type, severity, message
      });
      if(resp.data?.ok){
        showToast('Report submitted');
        reportModal?.hide();
        refreshArrivals();
        loadRecentReports();
      }else{
        showToast('Failed to submit report');
      }
    }catch{ showToast('Network error submitting report'); }
  };

  window.depart = async function(vid){
    try{
      const resp = await axios.post('/api/depart', { route_id: routeId, vehicle_id: vid, stop_name: stopName });
      if(resp.data?.ok){ showToast('Marked departed'); refreshArrivals(); }
      else { showToast('Failed to mark departure'); }
    }catch{ showToast('Network error marking departure'); }
  };

  function setLoading(on){
    document.getElementById('skeleton').classList.toggle('d-none', !on);
    document.getElementById('arrivals-table').classList.toggle('opacity-50', on);
  }

  async function refreshArrivals(){
    setLoading(true);
    try{
      const [arrivalsResp, statusResp] = await Promise.all([
        axios.get(`/api/arrivals?route_id=${encodeURIComponent(routeId)}&stop_name=${encodeURIComponent(stopName)}`),
        axios.get(`/api/vehicle_status?route_id=${encodeURIComponent(routeId)}`)
      ]);
      const arrivals = arrivalsResp.data.ok ? arrivalsResp.data.arrivals : [];
      const vStatus = (statusResp.data.ok && statusResp.data.vehicles) ? statusResp.data.vehicles : {};
      const tbody = document.getElementById('arrivals-body');
      tbody.innerHTML = '';
      for(const [eta, vid] of arrivals){
        const delay = (vStatus[vid]?.delayMinutes ?? 0);
        const delayBadge = delay > 0 ? `<span class="badge text-bg-warning text-dark ms-2">+${delay} min</span>` : '';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="fw-medium">${eta}</td>
          <td><span class="badge text-bg-primary">${vid}</span>${delayBadge}</td>
          <td class="d-flex flex-wrap gap-2">
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="openReport('delay','${vid}')"><i class="bi bi-hourglass-split"></i> Delay</button>
            <button type="button" class="btn btn-sm btn-outline-danger"  onclick="openReport('breakdown','${vid}')"><i class="bi bi-tools"></i> Breakdown</button>
            <button type="button" class="btn btn-sm btn-outline-success" onclick="depart('${vid}')"><i class="bi bi-check2-circle"></i> Departed</button>
          </td>`;
        tbody.appendChild(tr);
      }
      document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
    }finally{ setLoading(false); }
  }

  async function loadRecentReports(){
    try{
      const { data } = await axios.get(`/api/reports?route_id=${encodeURIComponent(routeId)}&limit=5`);
      const wrap = document.getElementById('recent-reports');
      if(!data.ok){ wrap.textContent = 'Error loading reports.'; return; }
      if(!data.items.length){ wrap.innerHTML = `<div class="text-secondary small">No recent reports.</div>`; return; }
      wrap.innerHTML = data.items.map(r => `
        <div class="d-flex justify-content-between align-items-center py-1 border-bottom">
          <div>
            <span class="badge text-bg-warning text-dark me-2">${r.type}</span>
            <span class="text-secondary small">sev ${r.severity}</span>
            <span class="ms-2 small">${r.vehicleId || '-'}</span>
            <span class="ms-2 small">${r.stop || '-'}</span>
          </div>
          <small class="text-secondary">${new Date((r.timestampEpoch||0)*1000).toLocaleTimeString()}</small>
        </div>`).join('');
    }catch(e){ console.error(e); }
  }

  
  refreshArrivals();
  loadRecentReports();
  setInterval(refreshArrivals, 8000);
});
</script>
{% endblock %}
